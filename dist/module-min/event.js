import{EventOptions}from"./type.js";import Mikado from"./mikado.js";const events={},event_options={},routes=Object.create(null),options=Object.create(null),doc=document.documentElement||document.body.parentNode,has_touch="ontouchstart"in window,has_pointer=!has_touch&&window.PointerEvent&&navigator.maxTouchPoints;let tap_fallback;export function handler(a,b){const c=a.target;if(c===window||c===doc)return;let d;b||(b=a.type);let e;if(e=c["_mke"+b],"undefined"==typeof e){for(let a=c;a&&a!==doc;){let f;if("click"===b&&tap_fallback&&(f=a.getAttribute("tap")),f||(f=a.getAttribute(b)),f){"$"===f[0]&&(d=a===c,f=f.substring(1));const g=f.indexOf(":");let h,i=a;if(-1<g){h=f.endsWith(":*");const a=f.substring(0,g),b=f.substring(g+1,f.length-(h?2:0));for(f="";(i=i.parentElement)!==doc;)if(!1,"root"===b?i._mkr:i.hasAttribute(b)){f=a;break}}if(f){e||(e=[],d&&(c["_mke"+b]=e)),e.push([f,i]);const a=options[f];if(!h||a&&(a.stop||a.cancel))break}}a=a.parentElement}d&&(e||(c["_mke"+b]=null))}else;if(e)for(let f,g=0;g<e.length;g++){f=e[g];const h=f[0],i=routes[h];if(i){const e=f[1],g=options[h];g&&(g.prevent&&a.preventDefault(),g.stop&&a.stopImmediatePropagation(),g.once&&(routes[h]=null,d&&(c["_mke"+b]=null))),!1,i(e,a)}}}export function route(a,b,c){return!1,routes[a]=b,options[a]=c||null,this}export function dispatch(a,b,c){return!1,routes[a](b||this,c||window.event),this}export function listen(a,b){return events[a]||(!1,register_event(1,a,handler,b),events[a]=1,event_options[a]=b||null),this}export function unlisten(a){return events[a]&&(!1,register_event(0,a,handler,event_options[a]),events[a]=0,event_options[a]=null),this}let touch_x,touch_y,register_tap;if(has_touch||has_pointer){function a(a){c(a,a.touches)}function b(a){const b=touch_x,d=touch_y;c(a,a.changedTouches),15>Math.abs(touch_x-b)&&15>Math.abs(touch_y-d)&&handler(a,"tap")}function c(a,b){b&&(a=b[0]),touch_x=a.clientX,touch_y=a.clientY}const d={passive:!1,capture:!0};register_tap=function(c){register_event(c,has_pointer?"pointerdown":"touchstart",a,d),register_event(c,has_pointer?"pointerup":"touchend",b,d)}}function register_event(a,b,c,d){if(!1,"tap"===b){if(has_touch||has_pointer)return void register_tap(a);tap_fallback=!0,b="click"}window[(a?"add":"remove")+"EventListener"](b,c,!(d||!1===d)||d)}